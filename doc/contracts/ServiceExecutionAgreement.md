
# Contract: ServiceExecutionAgreement

Documentation:
```
@title Service Execution Agreement
@author Ocean Protocol Team
@dev All function calls are currently implemented without side effects
```

## Structs

### public Template
Members:
* bool isExisting
* bool isRevoked
* address owner
* bytes32[] conditionKeys
* uint256[] dependenciesBits
* uint8[] fulfillmentIndices
* uint8 fulfillmentOperator

### public Agreement
Members:
* bool isExisting
* bool isFulfilled
* uint8[] conditionsState
* uint8[] conditionLockedState
* bytes32 templateId
* address consumer
* address publisher
* bytes32[] conditionInstances
* uint256[] timeoutValues
* bytes32 did

## Variables

### private templates

### private agreements

### private templateIdToAgreements

### private conditionKeyToIndex

## Events

###  TemplateSetup
Parameters:
* bytes32 templateId
* address provider

###  TemplateRevoked
Parameters:
* bytes32 templateId
* bool isRevoked

###  ConditionSetup
Parameters:
* bytes32 templateId
* bytes32 conditionKey
* address provider

###  ConditionInitialized
Parameters:
* bytes32 agreementId
* bytes32 condition
* bytes32 did
* bool status
* address templateOwner
* address consumer

###  ConditionFulfilled
Parameters:
* bytes32 agreementId
* bytes32 templateId
* bytes32 condition

###  AgreementInitialized
Parameters:
* bytes32 agreementId
* bytes32 templateId
* bytes32 did
* bool status
* address templateOwner
* address consumer

###  AgreementFulfilled
Parameters:
* bytes32 agreementId
* bytes32 templateId
* address owner

## Modifiers

### internal canRevokeTemplate
Parameters:
* bytes32 templateId

### internal noPendingFulfillments
Parameters:
* bytes32 agreementId

### internal isValidConditionHandler
Parameters:
* bytes32 agreementId
* bytes4 fingerprint
* bytes32 valueHash

### internal isTemplateOwner
Parameters:
* bytes32 templateId

### internal isValidExecuteRequest
Parameters:
* bytes32 templateId
* bytes32 agreementId

### internal isValidTemplateId
Parameters:
* bytes32 templateId

### internal onlyExistConditionKey
Parameters:
* bytes32 agreementId
* bytes32 condition

## Functions

### public setupTemplate

Documentation:

```
@notice setup Ocean's service execution agreement template only once!
@dev requires some initial checks before deploying template on-chain
@param templateId is a unique identifier for template generated by template owner using squid[py,js, or java]
@param contracts array of condition contracts that have the fulfillment functions
@param fingerprints array of 4 bytes of (fulfillment) function selectors
@param dependenciesBits describes the dependency model which embeds or encode the relationship between
template conditions and timeout flags
@param fulfillmentIndices include which conditions are in charge to fulfill the
agreement (mainly the reward functions)
@param fulfillmentOperator describes the relation between conditions in the fulfillment indices (0 --> AND,
1--> OR, N--> M-of-N)
@return true if the owner is able to setup the service execution agreement template
```
Parameters:
* bytes32 templateId
* address[] contracts
* bytes4[] fingerprints
* uint256[] dependenciesBits
* uint8[] fulfillmentIndices
* uint8 fulfillmentOperator

### public revokeTemplate

Documentation:

```
@notice revokeTemplate revokes the template agreement, so the template will not be used in the future
@param templateId is the service execution agreement template ID
@return true if the service execution agreement template was revoked
```
Parameters:
* bytes32 templateId

### public getTemplateOwner

Documentation:

```
@notice getTemplateOwner returns service execution agreement template owner
@param templateId is the service execution agreement template ID
@return template owner address
```
Parameters:
* bytes32 templateId

### public getTemplateId

Documentation:

```
@notice getTemplateId returns template Id using agreement ID
@param agreementId is the service execution agreement ID
@return service execution template ID
```
Parameters:
* bytes32 agreementId

### public getTemplateStatus

Documentation:

```
@notice getTemplateStatus is deprecated, use isTemplateRevoked instead (TODO)
```
Parameters:
* bytes32 templateId

### public isTemplateExisting

Documentation:

```
@notice isTemplateExisting checks if the template exists or does not.
@param templateId is the service execution agreement template ID
@return true if the template exists
```
Parameters:
* bytes32 templateId

### public isTemplateRevoked

Documentation:

```
@notice isTemplateExisting checks revocation status of the template
@param templateId is the service execution agreement template ID
@return true if the template is revoked
```
Parameters:
* bytes32 templateId

### public initializeAgreement

Documentation:

```
@notice initializeAgreement enables users to consume SEA templates by creating new instances
@dev validates the timeout length, reconstruct the agreement fingerprint and check the consumer signature,
it also embeds `serviceAgreementId` in signature as nonce generated by consumer to block Replay-attack
@param templateId is the service execution agreement template ID
@param signature is the signature of the consumer indicating that he/she agreed on the values for the conditions
@param consumer is the consumer's address
@param valueHashes is the hash of all values associated with conditions in the DID document
@param timeoutValues if exist (zero is the default value)
@param agreementId is (unique identifier) service agreement instance ID
@return true if the service agreement is successfully initialized
```
Parameters:
* bytes32 templateId
* bytes signature
* address consumer
* bytes32[] valueHashes
* uint256[] timeoutValues
* bytes32 agreementId
* bytes32 did

### public fulfillAgreement

Documentation:

```
@notice fulfillAgreement called in case of there are no pending fulfilments
@param agreementId is the service execution agreement ID
@return true if all the conditions are fulfilled according to the fulfillment criteria otherwise returns false
```
Parameters:
* bytes32 agreementId

### public hashAgreement

Documentation:

```
@notice hashAgreement generates unique fingerprint for agreement instance
@dev hashes all the parameters that is associated with the agreement
@param templateId is the SEA template ID
@param conditionKeys is an array of condition keys (hash(contract_address || function selector)
@param valueHashes is an array of hash of input values for the conditions, these values should be consistent with the
       passed values during the agreement initialization in order to get the same agreement hash
@param timeoutValues for each condition if exists, zero is the default value
@return agreement hash (unique identifier)
```
Parameters:
* bytes32 templateId
* bytes32[] conditionKeys
* bytes32[] valueHashes
* uint256[] timeoutValues
* bytes32 agreementId

### public getAgreementPublisher

Documentation:

```
@dev getAgreementPublisher retrieves the service execution agreement publisher address
@param agreementId is the SEA agreement ID
@return publisher address
```
Parameters:
* bytes32 agreementId

### public getAgreementConsumer

Documentation:

```
@dev getAgreementConsumer retrieves the service execution agreement consumer address
@param agreementId is the SEA agreement ID
@return consumer address
```
Parameters:
* bytes32 agreementId

### public isAgreementFulfilled

Documentation:

```
@dev isAgreementFulfilled retrieve the status of service execution agreement fulfilment
@param agreementId is the SEA agreement ID
@return true if the service execution agreement fulfilled
```
Parameters:
* bytes32 agreementId

### public isAgreementExisting

Documentation:

```
@dev isAgreementExisting checks if service execution agreement instance exists or not
@param agreementId is the SEA agreement ID
@return true if the service execution agreement exists
```
Parameters:
* bytes32 agreementId

### public fulfillCondition

Documentation:

```
@notice fulfillCondition called by condition fulfillment handler - authorized contract and function
(conditionContract.functionSlector)
@dev it reconstructs the condition key using the template Id, address of the sender and the function fingerprint,
checks that there is no pending fulfilment for dependency conditions, then locks all the dependency conditions
to avoid replay attack
@param agreementId is the SEA agreement ID
@param fingerprint is 4 bytes of (fulfillment) function selector
@param valueHash is hash of input values for the condition which is part of the fulfilment
@return true if all the children conditions are fulfilled and the caller is authorized to access this function
```
Parameters:
* bytes32 agreementId
* bytes4 fingerprint
* bytes32 valueHash

### public getConditionStatus

Documentation:

```
@notice condition state represents by  bits (1st bit for fulfilment 2nd bit (TODO: rename this function)
@dev getConditionStatus checks condition fulfilment status only if the condition key is exist
@param agreementId is the SEA agreement ID
@param conditionKey is located in DID which is a result of
hash(templateId || contractAddress || functionSelector (4bytes))
@return uint8 indicating the condition fulfilment status, the value holds all the information about
the dependency conditions and timeouts fulfillment
```
Parameters:
* bytes32 agreementId
* bytes32 conditionKey

### public hashCondition

Documentation:

```
@notice hashCondition used to generate condition instance from its key and input values hash in the DID
@dev hashes the condition key and input value hashes
@param conditionKey is hash(contractAddress || functionSelector)
@return condition Hash
```
Parameters:
* bytes32 conditionKey
* bytes32 valueHash

### public generateConditionKey

Documentation:

```
@notice generateConditionKey a utility function that is in charge to generate condition key
@dev hash ( template ID, conditionHandlerContractAddress , functionSelector/Fingerprint)
@param templateId is the SEA template ID
@param contractAddress is the contract address that is charge of fulfill set of conditions
@param fingerprint , condition handler function selector (4bytes) - only external and public functions
@return condition Key
```
Parameters:
* bytes32 templateId
* address contractAddress
* bytes4 fingerprint

### public generateConditionKeyForId

Documentation:

```
@notice generateConditionKeyForId a utility function that is in charge to generate condition key form agreement ID
@dev hash ( template ID, conditionHandlerContractAddress , functionSelector/Fingerprint)
@param agreementId is the SEA agreement ID
@param contractAddress is the condition handler contract address
@param fingerprint is condition handler function selector (4bytes) - only external and public functions
@return condition Key
```
Parameters:
* bytes32 agreementId
* address contractAddress
* bytes4 fingerprint

### public hasUnfulfilledDependencies

Documentation:

```
@notice hasUnfulfilledDependencies a utility function that is in charge to check if the condition has unfulfilled
dependency (conditions)
@dev gets the condition dependencies in terms of dependency bits, checks them and the timeouts they are associated with
@param agreementId is the SEA agreement ID
@param conditionKey is hash (template ID, ContractAddress , functionSelector/Fingerprint)
@return false if all the dependency conditions are fulfilled or there is no dependency conditions
```
Parameters:
* bytes32 agreementId
* bytes32 conditionKey

### public conditionTimedOut

Documentation:

```
@notice conditionTimedOut is called by any actor in order to retrieve the status of the condition timeout
@dev check the current block.timestamp is greater than the condition timeout (TODO:block.timestamp could be manipulated by miners)
@param agreementId is the SEA agreement ID
@param conditionKey is hash(templateId, contractAddress, functionSelector/Fingerprint)
@return true if the condition is timed out
```
Parameters:
* bytes32 agreementId
* bytes32 conditionKey

### private initializeConditions

Documentation:

```
@notice initializeConditions is called during agreement initialization
@dev condition is initialized by setting dependency conditions if exist, timeout values, and reconstructing the
condition key then derive the condition instance from this key, finally it emits event to notify the listeners
@param templateId is the SEA template Id
@param agreementId is the SEA agreement Id
@param valueHash is an array of the hashed input values that are associated with every condition
@param timeoutValues is an array of timeout values that are associated with the conditions (zero value is default)
@param did is a decentralized identifier that it is in charge of resolving the service
@return true if the condition is initialized without errors
```
Parameters:
* bytes32 templateId
* bytes32 agreementId
* bytes32[] valueHash
* uint256[] timeoutValues
* bytes32 did

### private lockChildConditions

Documentation:

```
@notice lockChildConditions is used to avoid replay attack if the parent conditions are fulfilled
@dev checks the dependency bits and timeouts of the child condition before setting the state of the condition to locked
@param agreementId is the SEA agreement ID
@param condition is hash(templateId, contractAddress, functionSelector/Fingerprint)
```
Parameters:
* bytes32 agreementId
* bytes32 condition
* uint256 dependenciesValue

### public getCurrentBlockNumber

Documentation:

```
@dev get the current blockchain number in ocean network
@return block.number
```

### public isValidSignature

Documentation:

```
@notice isValidSignature checks if the signature is valid
@param hash is SHA3 based hash of the original message
@param signature is an ECDSA based signature
@param consumer is the signer address
@return true if the recovered address equals the consumer's address
```
Parameters:
* bytes32 hash
* bytes signature
* address consumer

### private getBitValue

Documentation:

```
@notice this is utility function which performs bitwise operations over dependency bits for more info please
check out this blog post: https://blog.oceanprotocol.com/ocean-integration-fitchain-secure-on-premises-compute-59f43a944266
@dev using dependency bit value, bit position(0-> dependency flag, 1-> timeout flag), and the condition index, this function
can check if this condition has a dependency condition/s or not by using bitwise operation (AND) between value and 2^(condIndex * 2) + bit position(0, 1))
@param value is the dependency bits value for a condition (compressed version of flags)
@param conditionIndex is the index of the condition in the conditions list
@param bitPosition is the first bit for dependency flag, second bit for timeout flag
@param numBits currently we have 2 bits but this to keep the function more generic for future updates
@return dependency bit Value = 1 if this index is an a dependency condition for the parent condition, or the timeout was set to 1, otherwise returns zero
```
Parameters:
* uint256 value
* uint16 conditionIndex
* uint16 bitPosition
* uint16 numBits
